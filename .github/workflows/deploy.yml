name: Manual Deploy to SAP BTP CF

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout repo
      - name: Checkout Code
        uses: actions/checkout@v4

      # 2. Setup .NET 8
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      # 3. Install Cloud Foundry CLI
      - name: Install CF CLI
        run: |
          wget -q -O cf-cli.tgz "https://packages.cloudfoundry.org/stable?release=linux64-binary&source=github"
          tar -xzf cf-cli.tgz
          sudo mv cf /usr/local/bin/cf
          cf --version

      # 4. Publish .NET self-contained build
      - name: Publish .NET App
        run: |
          dotnet publish -c Release -r linux-x64 --self-contained true

      # 5. CF Login
      - name: CF Login
        run: |
          cf api "${{ secrets.CF_API }}"
          cf auth "${{ secrets.CF_USERNAME }}" "${{ secrets.CF_PASSWORD }}"
          cf target -o "${{ secrets.CF_ORG }}" -s "${{ secrets.CF_SPACE }}"

      # 6. Deploy app using manifest.yml
      - name: Deploy to BTP CF
        run: |
          cf push -f manifest.yml
