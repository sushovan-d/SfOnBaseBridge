name: Deploy to SAP BTP Cloud Foundry

on:
  workflow_dispatch:

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    steps:
    # ---------------------------
    # Checkout source code
    # ---------------------------
    - name: Checkout repository
      uses: actions/checkout@v4

    # ---------------------------
    # Setup .NET 8
    # ---------------------------
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    # ---------------------------
    # Publish self-contained Linux build
    # ---------------------------
    - name: Publish .NET app
      run: |
        dotnet publish SfOnBaseBridge/SfOnBaseBridge.csproj \
          -c Release \
          -r linux-x64 \
          --self-contained true \
          -o SfOnBaseBridge/bin/Release/net8.0/linux-x64/publish

        chmod +x SfOnBaseBridge/bin/Release/net8.0/linux-x64/publish/SfOnBaseBridge

    # ---------------------------
    # Debug — list published output
    # ---------------------------
    - name: List build output
      run: |
        echo "Published files:"
        ls -la SfOnBaseBridge/bin/Release/net8.0/linux-x64/publish

    # ---------------------------
    # Install CF CLI manually
    # ---------------------------
    - name: Install Cloud Foundry CLI
      run: |
        wget -O cf-cli.tgz "https://packages.cloudfoundry.org/stable?release=linux64-binary&source=github"
        mkdir cf-install
        tar -xzf cf-cli.tgz -C cf-install
        sudo mv cf-install/cf /usr/local/bin/cf
        cf --version

    # ---------------------------
    # Login to BTP CF
    # ---------------------------
    - name: CF Login
      env:
        CF_API: ${{ secrets.CF_API }}
        CF_USER: ${{ secrets.CF_USER }}
        CF_PASSWORD: ${{ secrets.CF_PASSWORD }}
        CF_ORG: ${{ secrets.CF_ORG }}
        CF_SPACE: ${{ secrets.CF_SPACE }}
      run: |
        cf api "$CF_API" --skip-ssl-validation
        cf auth "$CF_USER" "$CF_PASSWORD"
        cf target -o "$CF_ORG" -s "$CF_SPACE"

    # ---------------------------
    # Deploy to Cloud Foundry
    # ---------------------------
    - name: CF Push
      run: |
        cf push -f manifest.yml || echo "DEPLOYMENT_FAILED" > deploy_status.txt

    # ---------------------------
    # Fetch CF logs on crash
    # ---------------------------
    - name: Fetch crash logs
      if: always()
      run: |
        if [ -f deploy_status.txt ]; then
          echo "Deployment failed — fetching recent logs..."
          cf logs sfonbasebridge --recent
        else
          echo "Deployment succeeded."
        fi
